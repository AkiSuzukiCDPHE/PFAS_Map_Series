# R SCRIPT FOR CLEANING AND FORMATTING  DMR DATA 

install.packages("readxl")
library(readxl)
library(dplyr)

# Importing data
DMR_RawData <- read_excel("X:\\Shared drives\\_CDPHE TEEO Data\\_Enviro\\PFAS\\PFAS Concentration Map May 2024 Update\\PFASMap 2024_RProject\\01_Raw_Data\\DMR Data Report PFAS 20240701.xlsx")


# Replace all spaces in names of variables with underscores
names(DMR_RawData) <- gsub("\\s", "_", names((DMR_RawData)))

# Change ug/L units to ng/L
DMR_RawData <- DMR_RawData %>% mutate(Concentration_Units =case_when(Concentration_Units == "ug/L" ~ "ng/L",
                                                                     TRUE ~ Concentration_Units))

# Run a table to see the types of PFAS analytes included in the DF
PFAS_Types <- data.frame(table(DMR_RawData$Parameter))


# checking for duplicates of the same types of PFAS within NPDES ID for the same sampling date and same PFAS analyte. This creates a dataframe from them called "duplicates"
DMR_RawData <- DMR_RawData %>%
  group_by(NPDES_ID, DMR_Received_Date, Parameter) %>%
  distinct() %>%
  ungroup()

# Delete any observations with NODI codes other than NODI B
Codes_Delete <- c("NODI C", "NODI **E**", "NODI 7", "NODI 9" ,"NODI **P**","NODI **8**", "NODI N", "NODI 2", "NODI 3",  "NODI F")

# remove values of concentration 2 that are = "NODI C", "NODI **E**", "NODI 7", "NODI 9" ,"NODI **P**", or "NODI **8**"
DMR_RawData  <- DMR_RawData %>%
  filter(!Concentration_2 %in% Codes_Delete)

DMR_RawData  <- DMR_RawData %>%
  filter(!Concentration_3 %in% Codes_Delete)


# Create a variable with PFAS abbreviations called PFAS_Analyte
# Add PFOA

DMR_RawData <- DMR_RawData %>% 
  mutate(PFAS_Analyte = case_when(
    Parameter %in% c("Perfluorooctanesulfonamide") ~ "PFOSA",
    Parameter %in% c("Perfluoroheptanoic acid") ~ "PFHpA",
    Parameter %in% c("Perfluorobutanesulfonic acid") ~ "PFBS",
    Parameter %in% c("Perfluorododecanoic acid") ~ "PFDoA",
    Parameter %in% c("N-Methylperfluorooctanesulfonamide") ~ "NMeFOSA",
    Parameter %in% c("Perfluorononanoic acid") ~ "PFNA",
    Parameter %in% c("Perfluoroundecanoic acid") ~ "PFUnA",
    Parameter %in% c("N-Ethylperfluorooctanesulfonamide") ~ "NEtFOSA",
    Parameter %in% c("Perfluorohexanoic acid") ~ "PFHxA",
    Parameter %in% c("Perfluorotridecanoic acid") ~ "PFTrDA",
    Parameter %in% c("Perfluorononane sulfonic acid") ~ "PFNS",
    Parameter %in% c("Perfluorotetradecanoic acid") ~ "PFTeDA",
    Parameter %in% c("Perfluoropentane sulfonic acid") ~ "PFPeS",
    Parameter %in% c("Perfluoroheptanesulfonic acid") ~ "PFHpS",
    Parameter %in% c("4,8-Dioxa-3H-perfluorononanoic acid") ~ "ADONA",
    Parameter %in% c("Hexafluoropropylene oxide dimer acid") ~ "HFPO-DA",
    Parameter %in% c("Perfluorodecanoic acid") ~ "PFDA",
    Parameter %in% c("Perfluoropentanoic acid") ~ "PFPeA",
    Parameter %in% c("Perfluorooctanoic Acid") ~ "PFOA",
    Parameter %in% c("Perfluorohexanesulfonic acid") ~ "PFHxS",
    Parameter %in% c("2-[N-ethylperfluorooctanesulfonamido] acetic acid") ~ "NEtFOSAA",
    Parameter %in% c("Perfluorodecanesulfonic acid") ~ "PFDS",
    Parameter %in% c("Perfluorododecanesulfonic acid") ~ "PFDoS",
    Parameter %in% c("Perfluorooctanesulfonic acid") ~ "PFOS",
    Parameter %in% c("N-methyl perfluorooctanesulfonamidoacetic acid") ~ "NMeFOSAA",
    Parameter %in% c("Perfluoro-3,6-dioxaheptanoic acid") ~ "NFDHA",
    Parameter %in% c("Perfluorobutanoic Acid") ~ "PFBA",
    Parameter %in% c("Perfluoroethoxyethanesulfonic acid") ~ "PFEESA",
    Parameter %in% c("Potassium 9-chlorohexadecafluoro-3-oxanonane-1-sulfonate") ~ "9Cl-PF3ONS",
    Parameter %in% c("Perfluoro-4-methoxybutanoic acid") ~ "PFMBA",
    Parameter %in% c("Perfluoro-2-methoxypropanoic acid") ~ "PFMPA",
    Parameter %in% c("11-Chloroeicosafluoro-3-oxaundecane-1-sulfonic Acid") ~ "11Cl-PF3OUdS",
    Parameter %in% c("Potassium 11-chloroeicosafluoro-3-oxaundecane-1-sulfonate") ~ "11Cl-PF3OUdS",
    Parameter %in% c("4:2 Fluorotelomer sulfonic acid") ~ "4:2FTS",
    Parameter %in% c("6:2 Fluorotelomer sulfonic acid") ~ "6:2FTS",
    Parameter %in% c("3-Perfluoropropyl propanoic acid") ~ "3:3FTCA",
    Parameter %in% c("8:2 Fluorotelomer sulfonic acid") ~ "8:2FTS",
    Parameter %in% c("N-methylperfluorooctane Sulfonamidoethanol") ~ "NMeFOSE",
    Parameter %in% c("N-ethylperfluorooctane Sulfonamidoethanol") ~ "NEtFOSE",
    Parameter %in% c("3-Perfluoroheptyl propanoic acid") ~ "7:3FTCA",
    Parameter %in% c("2H,2H,3H,3H-Perfluorooctanoic acid") ~ "5:3FTCA",
    TRUE ~ Parameter
  ))


#Create a variable that has the MDL values for each type of PFAS analyte
DMR_RawData <- DMR_RawData %>% 
  mutate(MDL = case_when(
    PFAS_Analyte == "PFOSA" ~ 0.32,
    PFAS_Analyte == "PFHpA" ~ 0.37,
    PFAS_Analyte == "PFBS" ~ 0.37,
    PFAS_Analyte == "PFDoA" ~ 0.40,
    PFAS_Analyte == "NMeFOSA" ~ 0.43,
    PFAS_Analyte == "PFNA" ~ 0.45,
    PFAS_Analyte == "PFUnA" ~ 0.45,
    PFAS_Analyte == "NEtFOSA" ~ 0.45,
    PFAS_Analyte == "PFHxA" ~ 0.46,
    PFAS_Analyte == "PFTrDA" ~ 0.46,
    PFAS_Analyte == "PFNS" ~ 0.47,
    PFAS_Analyte == "PFTeDA" ~ 0.49,
    PFAS_Analyte == "PFPeS" ~ 0.50,
    PFAS_Analyte == "PFHpS" ~ 0.50,
    PFAS_Analyte == "ADONA" ~ 0.50,
    PFAS_Analyte == "HFPO-DA" ~ 0.51,
    PFAS_Analyte == "PFDA" ~ 0.52,
    PFAS_Analyte == "PFPeA" ~ 0.54,
    PFAS_Analyte == "PFOA" ~ 0.54,
    PFAS_Analyte == "PFHxS" ~ 0.54,
    PFAS_Analyte == "NEtFOSAA" ~ 0.59,
    PFAS_Analyte == "PFDS" ~ 0.60,
    PFAS_Analyte == "PFDoS" ~ 0.60,
    PFAS_Analyte == "PFOS" ~ 0.63,
    PFAS_Analyte == "NMeFOSAA" ~ 0.68,
    PFAS_Analyte == "NFDHA" ~ 0.75,
    PFAS_Analyte == "PFBA" ~ 0.79,
    PFAS_Analyte == "PFEESA" ~ 1.17,
    PFAS_Analyte == "9Cl-PF3ONS" ~ 1.38,
    PFAS_Analyte == "PFMBA" ~ 1.41,
    PFAS_Analyte == "PFMPA" ~ 1.46,
    PFAS_Analyte == "11Cl-PF3OUdS" ~ 1.67,
    PFAS_Analyte == "4:2FTS" ~ 1.69,
    PFAS_Analyte == "6:2FTS" ~ 2.45,
    PFAS_Analyte == "3:3FTCA" ~ 2.47,
    PFAS_Analyte == "8:2FTS" ~ 2.50,
    PFAS_Analyte == "NMeFOSE" ~ 3.81,
    PFAS_Analyte == "NEtFOSE" ~ 4.84,
    PFAS_Analyte == "7:3FTCA" ~ 8.71,
    PFAS_Analyte == "5:3FTCA" ~ 9.59
  ))


# Replace ND values with 0 and NA values with 0

# Concentration_3
 DMR_RawData <- DMR_RawData %>%
 mutate(Concentration_3 = ifelse(is.na(Concentration_3), 0,
                               ifelse(grepl("<|NODI B", Concentration_3), 0, Concentration_3)))
 
Zeroes <- DMR_RawData %>% filter(DMR_RawData$Concentration_3 == "0")

# Concentration_2
DMR_RawData1 <- DMR_RawData %>%
  mutate(Concentration_2 = ifelse(is.na(Concentration_2), 0,
                                  ifelse(grepl("<|NODI B", Concentration_2), 0, Concentration_2)))

# Check the replacement worked
Zeroes <- DMR_RawData1 %>% filter(DMR_RawData$Concentration_2 == "0" | DMR_RawData$Concentration_3 == "0")


# Check there arent any NA values
NAValues <- DMR_RawData1 %>% filter(is.na(Concentration_2) | is.na(Concentration_3))

# Convert Concentration_2 and # Concentration_3 to numeric
DMR_RawData1$Concentration_2 <- as.numeric(DMR_RawData1$Concentration_2)
DMR_RawData1$Concentration_3 <- as.numeric(DMR_RawData1$Concentration_3)


# Create Result Variable that is the average of Concentration_2 and Concentration_3

# Create a new variable for the average - when one of the concentrations is missing result should equal the value of the
# concentration that isn't missing.
DMR_RawData2 <- DMR_RawData1 %>%
  mutate(Result = ifelse(is.na(Concentration_2), Concentration_3,
                         ifelse(is.na(Concentration_3), Concentration_2,
                                (Concentration_2 + Concentration_3) / 2)))


class(DMR_RawData2$Result)

DMR_RawData2 <- DMR_RawData2 %>%
  mutate(Result = case_when(Result %in% c(0, 0.00, 0.000, 0.0000,0.0000000,0.0000000) ~ 0.0,
                            TRUE ~ Result))


# Remove columns you no longer need  
DMR_RawData3 <- DMR_RawData2 %>%
  select(-Parameter,  -Concentration_1, -Quantity_Units, -Quantity_1, -Quantity_2, -`Worst_%_exced.`)


# Transpose the dataset long to wide

# Filter data so there is one unique row for every combination of NPDES_ID, received date and parameter.
DMR_Unique <- DMR_RawData3 %>%
  distinct(NPDES_ID, Facility_Name, DMR_Received_Date, PFAS_Analyte, .keep_all = TRUE)


# Transpose the data from long to wide format:
# Id_Cols = specify the column(s) that you want to keep as identifiers (i.e., columns that remain as is and do not get spread)
# names_from =  specifies the column from which the values will be spread to form new columns.
# Values_from =  specifies the columns whose values will be spread into new columns (names_from columns).
install.packages("tidyverse")
library(tidyr)
library(dplyr)



aggregated_data2 <- DMR_Unique %>%
  group_by(NPDES_ID, DMR_Received_Date, PFAS_Analyte) %>%
  summarise(across(.cols = Result, .fns = function(x) ifelse(all(is.na(x)),NA, sum(x, na.rm = TRUE))),
            across(.cols = everything(), .fns = ~first(.))) %>%
  ungroup()



# Step 2: Transpose the aggregated data into wide format. Included all variables except SeasonID because it messed up the transposing for some reason.


wide_data_DMR <- aggregated_data2 %>%
  pivot_wider(
    id_cols = c("NPDES_ID", "DMR_Received_Date", "State_Code", "Region_Code" ,"Permit_Name", "Permittee_Address", "Facility_Name",
                "County", "Major_Minor_Indicator", "Permit_Type", "Permit_Status", "Federal_Grant_Flag", "Primary_SIC_Code", "Primary_NAICS_Code", "State_Water_Body", 
                "Latitude_in_Decimal_Degrees", "Longitude_in_Decimal_Degrees", "Mon._Period_End_Date", "Limit_Set", "Mon._Loc._Desc.", 
                "Concentration_Units", "Effluent_Vio._Exists", "Non-Receipt_Vio._Exists", 
                "DMR_Received_Date", "Change_of_Limit_Status_Code", "Limit_Type_Code"),
    names_from = PFAS_Analyte,
    values_from = Result,
    values_fill = list(Result = 0)
  )



# Rename Lats and Longs
wide_data_DMR <- wide_data_DMR %>% rename("Latitude"="Latitude_in_Decimal_Degrees", "Longitude" = "Longitude_in_Decimal_Degrees")

# Transform lats and longs to numeric variable
wide_data_DMR$Longitude <- as.numeric(wide_data_DMR$Longitude)
wide_data_DMR$Latitude <- as.numeric(wide_data_DMR$Latitude)

# Check they are numeric
class(wide_data_DMR$Latitude)
class(wide_data_DMR$Longitude)

# Create a dtaaframe with all the unique NPDES in the dataset
Count_NPDES_ID <- data.frame(unique(wide_data_DMR$NPDES_ID))

colnames(wide_data_DMR)

# Create a  variable that indicates if the permit is for groundwater "general permits" or waste water "NPDES Individual Permits"
wide_data_DMR <- wide_data_DMR %>%
  mutate(Media=ifelse(Permit_Type =="General Permit Covered Facility", "Groundwater", "Wastewater"))

# Rename variables to standardize across datasets, create variables, and remove extraneous variables
wide_data_DMR1 <- wide_data_DMR %>%
  rename(Name_OR_Site = Facility_Name,
         Permittee=Permit_Name,
         Address=Permittee_Address,
         Sample_Date=Mon._Period_End_Date,
         Notes= Permit_Status,
         Units=Concentration_Units) %>%
  mutate(Data_Source = "DMR Permits", Link_More_Info="https://docs.google.com/document/d/1KyRl6b-t1o73jK7mlZ8mhHn8ubbBbgZL-2hk6A1PyaA/edit") %>%
  select(-c(State_Code, Region_Code,Major_Minor_Indicator,Federal_Grant_Flag, Primary_SIC_Code, Limit_Set, Mon._Loc._Desc.,
            `Non-Receipt_Vio._Exists`, Change_of_Limit_Status_Code, Limit_Type_Code, DMR_Received_Date, State_Water_Body, County, Effluent_Vio._Exists, Primary_NAICS_Code))



wide_data_DMR1 <- wide_data_DMR1 %>% select(-`Total PFOA and PFOS`) %>% mutate(Number_Samples=2)
  
  
# Subsetting to wastewater and groundwater
wide_data_DMR_GW <- wide_data_DMR1 %>% filter(Permit_Type=="General Permit Covered Facility")
wide_data_DMR_Wastewater <-wide_data_DMR1 %>% filter(Permit_Type=="NPDES Individual Permit")



# Export the data frame as a cleaned and formatted dataset.

library("writexl")

write_xlsx(wide_data_DMR_GW,"X:\\Shared drives\\_CDPHE TEEO Data\\_Enviro\\PFAS\\PFAS Concentration Map May 2024 Update\\PFASMap 2024_RProject\\03_Clean_Data\\Groundwater\\DMR_GW.xlsx")

write_xlsx(wide_data_DMR_Wastewater,"X:\\Shared drives\\_CDPHE TEEO Data\\_Enviro\\PFAS\\PFAS Concentration Map May 2024 Update\\PFASMap 2024_RProject\\03_Clean_Data\\Wastewater\\DMR_Wastewater.xlsx")

